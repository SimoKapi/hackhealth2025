<!DOCTYPE html>
<html data-bs-theme="dark">

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Image box selector</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' media='screen' href='css/configure.css'>

    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"> -->
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<script>
    let config_type = window.location.pathname.split("/")[2]

    let config_values_register = {
        "ecmo": ["V", "P_ven", "P_int", "P_art", "Rotations"],
        "impella": ["Flow", "Locator 1", "Locator 2", "Rinse pressure", "Engine current 1", "Engine current 2", "Impella flow"]
    }
</script>

<body>
    <nav class="navbar navbar-expand mb-2">
        <div class="container-fluid">
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" id="data-link">View data</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active">Settings</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item align-items-center d-flex form-inline" >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-brightness-high-fill" viewBox="0 0 16 16">
                            <path d="M12 8a4 4 0 1 1-8 0 4 4 0 0 1 8 0M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0m0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13m8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5M3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8m10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0m-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0m9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707M4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708"/>
                        </svg>
                        <div class="ms-2 form-check form-switch">
                            <input class="form-check-input" type="checkbox" checked role="switch" id="themingSwitcher" onclick="switchLightMode()" />
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-moon-fill" viewBox="0 0 16 16">
                            <path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278"/>
                        </svg>      
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="container" style="position: relative; min-height:50px; width:max-content; padding:0;" class="container">
        <img id="img" src="/firefox.jpg" style="max-height: 100vh; max-width: 60vw;">
        <div id="rect_container" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;">
        </div>
    </div>
    <div class="container selection-list">
        <div>
            <!-- <input type="file" onchange="load_img(this)"> -->
            <button class="btn btn-primary" onclick="load_latest()">Load Latest Image</button>
        </div>
        <hr>
        <button class="btn btn-secondary" onclick="create_rect()">Add Rectangle</button>
        <button class="btn btn-secondary" onclick="clearSelection()">Reset selection</button>
        <ul id="selections">

        </ul>
        <button class="btn btn-warning" onclick="request_sample()">Request Sample</button>

        <button class="btn btn-success" onclick="save_configuration()">Save Configuration</button>
    </div>
</body>

<script>

    const url = `${window.location.protocol}//${window.location.host}`

    const datalink = document.getElementById("data-link")
    datalink.href=`../${config_type}.html`

    let rect_register = {}

    function load_img(input) {
        if (input.files && input.files[0]) {
            let reader = new FileReader();

            reader.onload = (e) => {
                document.getElementById("img").src = e.target.result
            }

            reader.readAsDataURL(input.files[0])
        }
    }

    let latest_name = undefined;

    async function load_latest() {
        let res = await fetch(`${url}/image/latest/${config_type}`)
        latest_name = await res.text();

        let res_img = await fetch(`${url}/image/file/${config_type}/${latest_name}`)
        var objectURL = URL.createObjectURL((await res_img.blob()));
        document.getElementById("img").src = objectURL
    }

    function create_dropdown(values = []) {
        let dropdown = document.createElement("select");
        for (let val of values) {
            let el = document.createElement("option");
            el.innerText = val;
            el.value = val;
            dropdown.appendChild(el);
        }
        return dropdown;
    }

    function create_rect() {
        let el = (() => {
            let el = document.createElement("div");
            el.setAttribute("class", "rect");
            el.setAttribute("style", "position: absolute; top: 0; min-height: 20px; min-width: 20px; background-color: #00ffff6e;");
            return el;
        })();
        el.el_id = [0, 0, 0, 0, 0, 0, 0, 0, 0,].map(a => Math.random() * 1000000).join()

        let di = document.createElement("div")
        di.style.cssText = "display: flex; flex-direction: row;"
        di.addEventListener("mouseenter", (event) => {
            el.col_backup = el.style.backgroundColor;
            el.style.backgroundColor = "rgba(187, 255, 0, 0.43)"
        })
        di.addEventListener("mouseleave", (event) => {
            el.style.backgroundColor = el.col_backup;
        })
        {
            let li = document.createElement("li");
            li.style.cssText = "margin-right: 10px;"
            li.innerText = `X: 0; Y: 0; WIDTH: 0; HEIGHT: 0`;
            di.li = li;
            di.appendChild(li)

            let dropdown = create_dropdown(config_values_register[config_type]);
            dropdown.style.cssText = "margin-right: 10px;"
            di.label = dropdown
            di.appendChild(dropdown)

            let b = document.createElement("button");
            b.innerText = "Remove";
            b.className = "btn btn-danger"
            b.onclick = () => {
                if (selected_rectangle == rect_register[el.el_id]["rectangle"]) {
                    selected_rectangle = null;
                }

                rect_register[el.el_id]["selection"].remove();
                rect_register[el.el_id]["rectangle"].remove();
                delete rect_register[el.el_id];
                // el.remove();
            }
            di.appendChild(b)
        }

        rect_register[el.el_id] = {};
        rect_register[el.el_id]["rectangle"] = el
        rect_register[el.el_id]["selection"] = di;

        document.getElementById("rect_container").appendChild(el)
        document.getElementById("selections").appendChild(di)


        selected_rectangle = el;
        el.style.pointerEvents = "none";
        el.style.backgroundColor = "#8000808c";
    }


    let container = document.getElementById("container");

    let selected_rectangle = null;
    let count = 0;

    container.addEventListener("click", (event) => {

        if (event.target.classList.contains("rect") && selected_rectangle === null) {
            selected_rectangle = event.target;
            while (selected_rectangle.firstChild) {
                selected_rectangle.lastChild.remove()
            }
            selected_rectangle.style.pointerEvents = "none";
            selected_rectangle.style.backgroundColor = "#8000808c";
            return;
        }

        // let c = window.getComputedStyle(container);
        let c = container.getBoundingClientRect();

        let relY = event.clientY - c.top;
        let relX = event.clientX - c.left;

        let top = Math.round(relY);
        let bottom = Math.round(c.height - relY);

        let left = Math.round(relX);
        let right = Math.round(c.width - relX);

        if (selected_rectangle === null) {
            if (count > 1) {
                count = 0;
            }
            return;
        }
        // console.log(top, bottom, left, right)

        if (count == 0) {
            selected_rectangle.style.top = `${top}px`
            selected_rectangle.style.left = `${left}px`
            selected_rectangle.style.backgroundColor = "rgba(25, 340, 0, 0.43)"
        }
        if (count == 1) {
            selected_rectangle.style.bottom = `${bottom}px`
            selected_rectangle.style.right = `${right}px`
        }

        let q = window.getComputedStyle(selected_rectangle);
        rect_register[selected_rectangle.el_id]["selection"].li.innerText = `X: ${q.left}; Y: ${q.top}; WIDTH: ${q.width}; HEIGHT: ${q.height}`

        count++;
        console.log(count)
        if (count > 1) {
            count = 0;
            selected_rectangle.style.backgroundColor = "#00ffff6e";
            selected_rectangle.style.pointerEvents = "auto";
            selected_rectangle = null
        }

    })

    function get_areas(){
        let img = document.getElementById("img")
        let comp_img = window.getComputedStyle(img);

        let k1 = img.naturalWidth / Number.parseFloat(comp_img.width);
        let k2 = img.naturalHeight / Number.parseFloat(comp_img.height);

        let output = [];
        for (let k in rect_register) {
            let q = window.getComputedStyle(rect_register[k]["rectangle"])
            let obj = {
                x: Number.parseFloat(q.left) * k1,
                y: Math.min(img.naturalHeight, Number.parseFloat(q.top) * k2),
                width: Number.parseFloat(q.width) * k1,
                height: Number.parseFloat(q.height) * k2,
                label: rect_register[k]["selection"].label.value
            }
            if (obj.y + obj.height > img.naturalHeight) { obj.height = img.naturalHeight - obj.y }
            output.push(obj)
        }

        return output;
    }

    async function request_sample() {
        let areas = get_areas()
        
        // console.log(output)
        if (latest_name !== undefined) {
            let res = await fetch(`${url}/ocr/sample/${config_type}`, {
                method: "POST",
                headers: { "content-type": "application/json" },
                body: JSON.stringify({
                    image_name: latest_name,
                    areas: areas
                })
            })
            if (res.ok) {
                let j = await res.json();
                for (let val of j) {
                    for (let k in rect_register) {
                        if (rect_register[k]["selection"].label.value == val["id"]) {
                            while (rect_register[k]["rectangle"].firstChild) {
                                rect_register[k]["rectangle"].lastChild.remove();
                            }
                            let el = document.createElement("div");
                            el.style.cssText = "pointer-events: none; position: absolute; bottom: 100%; background-color: white;"
                            el.innerText = val["value"]
                            el.className = "alert alert-dark p-1 mb-0"
                            el.setAttribute("data-bs-theme", "light")
                            rect_register[k]["rectangle"].appendChild(el)
                        }
                    }
                }
            }
        }
    }

    async function save_configuration() {
        let areas = get_areas()

        let res = await fetch(`${url}/api/configure/${config_type}`, {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({
                image_name: latest_name,
                areas: areas
            })
        })
        if (res.ok) {
        }
    }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    function switchLightMode() {
        if (document.documentElement.getAttribute('data-bs-theme') == 'dark') {
            document.documentElement.setAttribute('data-bs-theme','light')
        }
        else {
            document.documentElement.setAttribute('data-bs-theme','dark')
        }
        }
</script>

</html>