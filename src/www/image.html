<!doctype html>

<html>

    <head>
        <title>Perspective.js demo</title>
        <style>
            canvas {
                border: gray solid 1px;
            }
        </style>
    </head>

    <body>
        <canvas width="100vh" height="450" id="canvas"></canvas>
        <script src="perspective/canvas2image.js"></script>
        <script src="perspective/perspective.js"></script>
        <script>

var ctx, ctx1, ctx2;
var points = [[50, 50], [550, 100], [300, 400], [100, 400]];

window.addEventListener("load", function() {
	var canvas = document.getElementById("canvas");

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
	// var ctx = canvas.getContext('2d');
    ctx = canvas.getContext('2d');
	// 変形画像貼り付け用canvas要素
	var canvas1 = document.createElement('canvas');
	canvas1.width = canvas.width;
	canvas1.height = canvas.height;
	// var ctx1 = canvas1.getContext('2d');
    ctx1 = canvas1.getContext('2d');
	// 補助線貼り付け用canvas要素
	var canvas2 = document.createElement('canvas');
	canvas2.width = canvas.width;
	canvas2.height = canvas.height;
	// var ctx2 = canvas2.getContext('2d');
    ctx2 = canvas2.getContext('2d');
	// canvas要素
	//
	var op = null;
	// img要素
	var img = new Image();
    // img.crossOrigin = "";
	img.src = 'firefox.jpg';
	img.onload = function() {
		op = new Perspective(ctx1, img);
		op.draw(points);
		prepare_lines(ctx2, points);
		draw_canvas(ctx, ctx1, ctx2);
	};
	// canvas要素にマウス関連イベントのリスナーをセット
	var drag = null;
	canvas.addEventListener("mousedown", function(event) {
		event.preventDefault();
		var p = get_mouse_position(event);
		for( var i=0; i<4; i++ ) {
			var x = points[i][0];
			var y = points[i][1];
			if( p.x < x + 10 && p.x > x - 10 && p.y < y + 10 && p.y > y - 10 ) {
				drag = i;
				break;
			}
		}
	}, false);
	canvas.addEventListener("mousemove", function(event) {
		event.preventDefault();
		if(drag == null) { return; }
		var p = get_mouse_position(event);
		points[drag][0] = p.x;
		points[drag][1] = p.y;
		prepare_lines(ctx2, points, true);
		draw_canvas(ctx, ctx1, ctx2);
	}, false);
	canvas.addEventListener("mouseup", function(event) {
		event.preventDefault();
		if(drag == null) { return; }
		var p = get_mouse_position(event);
		points[drag][0] = p.x;
		points[drag][1] = p.y;
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		ctx1.clearRect(0, 0, canvas.width, canvas.height);
var s = (new Date()).getTime();
		op.draw(points);
// document.getElementById("ms").innerHTML = ( (new Date()).getTime() - s );
		prepare_lines(ctx2, points);
		draw_canvas(ctx, ctx1, ctx2);
		drag = null;
	}, false);
	canvas.addEventListener("mouseout", function(event) {
		event.preventDefault();
		drag = null;
	}, false);
	canvas.addEventListener("mouseenter", function(event) {
		event.preventDefault();
		drag = null;
	}, false);

}, false);

function prepare_lines(ctx, p, with_line, with_point = true) {
	ctx.save();
	//ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	//
	if( with_line == true ) {
		ctx.beginPath();
		ctx.moveTo(p[0][0], p[0][1]);
		for( var i=1; i<4; i++ ) {
			ctx.lineTo(p[i][0], p[i][1]);
		}
		ctx.closePath();
		ctx.strokeStyle = "red";
		ctx.stroke();
	}
	//
    ctx.fillStyle = "red";
    for( var i=0; i<4; i++ ) {
        ctx.beginPath();
        ctx.arc(p[i][0], p[i][1], 4, 0, Math.PI*2, true);
            if(with_point){
                ctx.fill();
            }
        }
	//
	ctx.restore();
}

function draw_canvas(ctx, ctx1, ctx2) {
	ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
	ctx.drawImage(ctx1.canvas, 0, 0);
	ctx.drawImage(ctx2.canvas, 0, 0);
}

function get_mouse_position(event) {
	var rect = event.target.getBoundingClientRect() ;
	return {
		x: event.clientX - rect.left,
		y: event.clientY - rect.top
	};
}

function scaleCanvas(canvas, width, height) {
        const w = canvas.width,
            h = canvas.height;
        if (width === undefined) {
            width = w;
        }
        if (height === undefined) {
            height = h;
        }

        let retCanvas = document.createElement("canvas");
        let retCtx = retCanvas.getContext("2d");
        retCanvas.width = width;
        retCanvas.height = height;
        retCtx.drawImage(canvas, 0, 0, w, h, 0, 0, width, height);
        return retCanvas;
    }

function getDataURL(canvas, type, width, height) {
    canvas = scaleCanvas(canvas, width, height);
    return canvas.toDataURL(type);
}

function saveFile(strData, fileType, fileName = "name") {
        // document.location.href = strData;
        let saveLink = document.createElement("a");
        // download file name
        saveLink.download = fileName + "." + fileType;
        // download file data
        saveLink.href = strData;
        // start download
        saveLink.click();
    }

    function genImage(strData) {
        let img = document.createElement("img");
        img.src = strData;
        return img;
    }

function crop_export(canvas){
    // var canvas = ctx.canvas, 
    w = canvas.width, h = canvas.height,
    pix = {x:[], y:[]},
    imageData = ctx.getImageData(0,0,canvas.width,canvas.height),
    // x, y, index;

    console.log(imageData)
  
  for (y = 0; y < h; y++) {
    for (x = 0; x < w; x++) {
      index = (y * w + x) * 4;
      if (imageData.data[index+3] > 0) {
        pix.x.push(x);
        pix.y.push(y);
      } 
    }
  }
  pix.x.sort(function(a,b){return a-b});
  pix.y.sort(function(a,b){return a-b});
  var n = pix.x.length-1;
  
  w = 1 + pix.x[n] - pix.x[0];
  h = 1 + pix.y[n] - pix.y[0];
  var cut = ctx.getImageData(pix.x[0], pix.y[0], w, h);

  canvas.width = w;
  canvas.height = h;
  ctx.putImageData(cut, 0, 0);

  return canvas.toDataURL()
}

function export_image(){
    prepare_lines(ctx2, points, false, false)
    draw_canvas(ctx, ctx1, ctx2);

    // console.log(getDataURL(canvas, "png", window.width, window.height))

    const strData = crop_export(canvas)//getDataURL(canvas, "png", window.width, window.height);
    saveFile(strData, "png", "title")

    prepare_lines(ctx2, points, false, true)
    draw_canvas(ctx, ctx1, ctx2);
    // Canvas2Image.saveAsPNG(canvas, window.width, window.height, "img")
    // const strData = Canvas2Image.getDataURL(canvas, "png", window.width, window.height);
    // return Canvas2Image.genImage(strData);
    // return Canvas2Image.convertToPNG(canvas, window.width, window.height, "img")
    // var link = document.createElement('a');
    // link.download = "PhylogeneticTree.png";
    // link.href = canvas.toDataURL();
    // link.click();
}

        </script>
    </body>

</html>
