<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ECMO viewer</title>
    <link rel="stylesheet" href="css/view.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=refresh" />
    <link href="css/bootstrap.css" rel="stylesheet">
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js">
    </script>
</head>
<body>
    <nav class="navbar navbar-expand mb-2">
        <div class="container-fluid">
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active">View data</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/configure/ecmo">Settings</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item align-items-center d-flex form-inline" >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-brightness-high-fill" viewBox="0 0 16 16">
                            <path d="M12 8a4 4 0 1 1-8 0 4 4 0 0 1 8 0M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0m0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13m8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5M3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8m10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0m-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0m9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707M4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708"/>
                        </svg>
                        <div class="ms-2 form-check form-switch">
                            <input class="form-check-input" type="checkbox" checked role="switch" id="themingSwitcher" onclick="switchLightMode()" />
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-moon-fill" viewBox="0 0 16 16">
                            <path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278"/>
                        </svg>      
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="main">
        <h1>ECMO data viewer</h1>
        <div class="dashboard p-2 d-md-flex">
            <div class="data">
                <h2>Raw data</h2>
                <div class="alert alert-success">
                    System is active
                </div>
                <table class="table mx-auto">
                    <tbody>
                        <tr>
                            <td><button class="btn btn-outline-primary val-name" onclick="selectSet(0)">V</button> <span id="V">-</span> lpm</td>
                            <td><button class="btn btn-outline-primary val-name" onclick="selectSet(1)"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                              </svg></button> <span id="Rotations">-</span> rpm</td>
                        </tr>
                        <tr>
                            <td><button class="btn btn-outline-primary val-name" onclick="selectSet(2)">P<sub>Ven</sub></button> <span id="P_ven">-</span> mmHg</td>
                            <td><button class="btn btn-outline-primary val-name" onclick="selectSet(3)">P<sub>Art</sub></button> <span id="P_art">-</span> mmHg</td>
                        </tr>
                        <tr>
                            <td><button class="btn btn-outline-primary val-name" onclick="selectSet(4)">P<sub>Int</sub></button> <span id="P_int">-</span> mmHg</td>
                            <td><button class="btn btn-outline-primary val-name" onclick="selectSet(5)">T<sub>Art</sub></button> <span id="T_art">-</span> °C</td>
                        </tr>
                        <tr>
                            <td><button class="btn btn-outline-primary val-name" onclick="selectSet(6)">Δp</button> <span id="D_P">-</span> mmHg</td>
                            <td><button class="btn btn-outline-primary val-name" onclick="selectSet(7)">S<sub>v</sub>O<sub>2</sub></button> <span id="SvO2">-</span> %</td>
                        </tr>
                    </tbody>
                </table>
                <!-- <div class="alert alert-warning" role="alert">
                    Warning - Screen has been changed
                </div>
                <div class="alert alert-warning">
                    Warning - unreadable data
                </div> -->
            </div>
            <hr>
            <div class="graphs">
                <h2>Graph</h2>
                <div class="card flex-fill w-100 draggable">
                    <div class="card-header">
                        <h5 class="card-title mb-0" id="set_title">Overall score</h5>
                    </div>
                    <div class="card-body py-3">
                        <div class="chart chart-sm"><div class="chartjs-size-monitor"><div class="chartjs-size-monitor-expand"><div class=""></div></div><div class="chartjs-size-monitor-shrink"><div class=""></div></div></div>
                            <canvas id="myChart" style="width:100%;max-width:700px"></canvas>
                        </div>
                    </div>
                </div>
                
                <script>
                    // const ip = "172.16.88.80"
                    const ip = "localhost"
                    class dataset {
                        constructor(x, y, xlabel, ylabel, ymax, color) {
                            // this.name = name
                            this.x = [...x]
                            this.y = y
                            this.xlabel = xlabel
                            this.ylabel = ylabel
                            this.ymax = ymax
                            this.color = color
                        }
                    }

                    const dataLimit = 20
                    const xAxis = Array(dataLimit).fill(1).map((a, i) => 1*(i + 1))
                    // const xAxis = [10, 20, 30, 40, 50, 60, 70, 80, 90, 100]
                    let globalTimer = 0
                    const datasets = [
                        new dataset(
                            xAxis,
                            [],
                            "time (s)",
                            "V",
                            5,
                            "rgba(255, 0, 0, 1)"
                        ),
                        new dataset(
                            xAxis,
                            [],
                            "time (s)",
                            "Rotations",
                            5,
                            "rgba(255, 0, 0, 1)"
                        ),
                        new dataset(
                            xAxis,
                            [],
                            "time (s)",
                            "P_ven",
                            5,
                            "rgba(255, 0, 0, 1)"
                        ),
                        new dataset(
                            xAxis,
                            [],
                            "time (s)",
                            "P_art",
                            150,
                            "rgba(255, 0, 0, 1)"
                        ),
                        new dataset(
                            xAxis,
                            [],
                            "time (s)",
                            "P_int",
                            5,
                            "rgba(255, 0, 0, 1)"
                        ),
                        new dataset(
                            xAxis,
                            [],
                            "time (s)",
                            "T_art",
                            5,
                            "rgba(255, 0, 0, 1)"
                        ),
                        new dataset(
                            xAxis,
                            [],
                            "time (s)",
                            "D_P",
                            5,
                            "rgba(255, 0, 0, 1)"
                        ),
                        new dataset(
                            xAxis,
                            [],
                            "time (s)",
                            "SvO2",
                            5,
                            "rgba(255, 0, 0, 1)"
                        )
                    ]

                    const socket = new WebSocket(`ws://${ip}:9200/ecmo/export/json`)
                    socket.addEventListener("message", (msg) => {
                        globalTimer++;
                        console.log(msg)
                        const parsed = JSON.parse(msg.data)
                        for (let i = 0; i < datasets.length; i++) {
                            if (!parsed.map((item) => item.id).includes(datasets[i].ylabel)) continue
                            const index = datasets[i].ylabel
                            const id = index.replaceAll(" ", "_")
                            const idValue = parsed.find(i => i.id == index).value
                            document.getElementById(id).textContent = idValue
                            datasets[i].y.push(idValue)
                            while (datasets[i].y.length > dataLimit) {
                                datasets[i].y.shift()
                                datasets[i].x.push(globalTimer)
                                datasets[i].x.shift()
                            }

                            // datasets[i].x.push(globalTimer) 
                            // while (datasets[i].x.length > dataLimit) {
                            //     datasets[i].x.shift()
                            // }
                            // if (datasets[i].y.length > dataLimit) {
                            //     datasets[i].y.shift()
                            //     // Only push a new time label if we are already at the limit
                            // }
                        }

                        // currentSeconds += 1;
                        // if (currentSeconds > 20) {
                        //     ds.x.push(currentSeconds); 
                        //     ds.x.shift();
                        // }
                        selectSet(currentIndex)
                    })

                    const chart = new Chart("myChart", {
                        type: "line",
                        data: {
                            labels: [],
                            datasets: []
                        },
                        options:{
                            animation: {
                                duration: 0
                            },
                            legend: {
                                display: false
                            },
                            scales: {
                                xAxes: [{
                                    scaleLabel: {
                                        display: true,
                                        labelString: "",
                                        fontSize: 14,
                                    }
                                }],
                                yAxes: [{
                                    color: "rgba(255, 255, 255, 0.1)",
                                    scaleLabel: {
                                        display: true,
                                        labelString: "",
                                        fontSize: 14,
                                    },
                                    ticks: {
                                        beginAtZero: true,
                                        min: 0,
                                        max: 5,
                                        stepSize: 1
                                    }
                                }]
                            }
                        }
                    })

                    function updateChart(newValue) {
                        const dataset = chart.data.datasets[0].data;
                        
                        // 1. Add new data
                        dataset.push(newValue);
                        
                        // 2. If we exceed the limit, remove the oldest piece of data
                        if (dataset.length > dataLimit) {
                            dataset.shift();
                        }

                        // 3. Update without animation
                        chart.update('none');
                    }

                    let currentIndex = 0
                    function selectSet(setIndex) {
                        currentIndex = setIndex
                        chart.data.labels = datasets[setIndex].x
                        chart.data.datasets = [{
                            label: datasets[setIndex].ylabel,
                            data: datasets[setIndex].y,
                            borderColor: datasets[setIndex].color,
                            fill: false,
                            steppedLine: true,
                            lineTension: 0,
                            pointRadius: 0
                        }]
                        chart.options.scales.yAxes[0].ticks.max = datasets[setIndex].ymax
                        chart.options.scales.xAxes[0].scaleLabel.labelString = datasets[setIndex].xlabel
                        chart.options.scales.yAxes[0].scaleLabel.labelString = datasets[setIndex].ylabel
                        chart.data.labels = datasets[setIndex].x;
                        chart.update()
                        const set_title = document.getElementById("set_title")
                        set_title.textContent = datasets[setIndex].name
                    }
                </script>
            </div>
        </div>
    </div>

</body>
<script src="/js/bootstrap.js"></script>
<script>
    function switchLightMode() {
        if (document.documentElement.getAttribute('data-bs-theme') == 'dark') {
            document.documentElement.setAttribute('data-bs-theme','light')
        }
        else {
            document.documentElement.setAttribute('data-bs-theme','dark')
        }
        }
</script>
</html>